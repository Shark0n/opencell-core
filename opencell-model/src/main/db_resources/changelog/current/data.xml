<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.5.xsd">

    <changeSet author="AbdelmounaimAkadid" id="#3224_16022018">
        <insert tableName="adm_role">
            <column name="id" valueNumeric="-6" />
            <column name="version" valueNumeric="0" />
            <column name="role_description" value="Customer care user" />
            <column name="role_name" value="CUSTOMER_CARE_USER" />
        </insert>
        <insert tableName="adm_role_role">
            <column name="role_id" valueNumeric="-6" />
            <column name="child_role_id" valueNumeric="-3" />
        </insert>
        <insert tableName="adm_role_permission">
            <column name="role_id" valueNumeric="-6" />
            <column name="permission_id" valueNumeric="14" />
        </insert>
        <insert tableName="adm_role_permission">
            <column name="role_id" valueNumeric="-6" />
            <column name="permission_id" valueNumeric="1" />
        </insert>
    </changeSet>
	
	<changeSet id="#3260_20180227 - Add finance roles" author="EdwardPLegaspi">
		<insert tableName="adm_role">
            <column name="id" value="-7" />
            <column name="version" value="0" />
            <column name="role_description" value="Finance Management" />
            <column name="role_name" value="financeManagement" />
        </insert>
        <insert tableName="adm_role">
            <column name="id" value="-8" />
            <column name="version" value="0" />
            <column name="role_description" value="Finance Visualization" />
            <column name="role_name" value="financeVisualization" />
        </insert>
        <insert tableName="adm_user_role">
        	<column name="user_id" value="-1"></column>
        	<column name="role_id" value="-7"></column>
        </insert>
        <insert tableName="adm_user_role">
        	<column name="user_id" value="-1"></column>
        	<column name="role_id" value="-8"></column>
        </insert>
	</changeSet>
	<changeSet author="anasseh" id="#3167_20022018">
	    <sql>update ${db.schema}.ar_payment_gateway set description ='Ingenico API Connect OGONE for Sepa payments', code='INGENICO_OGONE_SEPA', uuid='gateway_INGENICO_ONGONE' ,disabled=0, trading_currency_id = -1 , payment_method ='DIRECTDEBIT' where id =-1</sql> 
	    <sql>delete from ${db.schema}.ar_payment_gateway where id =-2</sql> 
	    <sql>delete from ${db.schema}.ar_payment_gateway where id =-3</sql>   
	   	<insert tableName="ar_payment_gateway">
			<column name="id" valueNumeric="-2" />
			<column name="version" valueNumeric="0" />
			<column name="disabled" valueNumeric="0" />
			<column name="created" valueDate="now()" />
			<column name="code" value="SLIMPAY_SEPA" />
			<column name="description" value="Slimpay for Sepa payments" />
			<column name="type" value="NATIF" />
			<column name="payment_method" value="DIRECTDEBIT" />
			<column name="implementation_class_name" value="org.meveo.service.payments.impl.SlimpayGatewayPayment" />
			<column name="trading_currency_id" value="-2" /><!-- EUR -->
			<column name="uuid" value="gateway_SLIMPAY" />
		</insert>  	
	   	<insert tableName="ar_payment_gateway">
			<column name="id" valueNumeric="-3" />
			<column name="version" valueNumeric="0" />
			<column name="disabled" valueNumeric="0" />
			<column name="created" valueDate="now()" />
			<column name="code" value="INGENICO_OGONE_CARD" />
			<column name="description" value="Ingenico API Connect OGONE for Card payments" />
			<column name="type" value="NATIF" />
			<column name="payment_method" value="CARD" />
			<column name="implementation_class_name" value="org.meveo.service.payments.impl.SlimpayGatewayPayment" />
			<column name="trading_currency_id" value="-2" /><!-- EUR -->
			<column name="uuid" value="gateway_SLIMPAY" />
		</insert> 			 
    </changeSet>
    <changeSet author="anasseh" id="#3110_08032018">
   		 <sql>delete from ${db.schema}.crm_provider_pay_methods where payment_method='NONE'</sql>   
    </changeSet>
    
    <changeSet id="#1705_20180220-migration" author="EdwardPLegaspi">
    	<sql>
			<![CDATA[
			insert into billing_accounting_code (code, id, version, disabled, created, creator, chart_of_account_type, chart_of_account_view_type)
				select a.accounting_code, nextval('billing_accounting_code_seq'), 0, 0, now(), null, 'ASSETS', 'REGULAR' 
			    from 
			        (select distinct accounting_code from billing_invoice_sub_cat where accounting_code is not null and accounting_code<>'' 
					and not exists(select * from billing_accounting_code where code=accounting_code)) a;
			]]>
		</sql>
		<sql>
			<![CDATA[
			update billing_invoice_sub_cat set accounting_code_id=(select id from billing_accounting_code where code=accounting_code);
			]]>
		</sql>
		<sql>
			<![CDATA[
			insert into billing_accounting_code (code, id, version, disabled, created, creator, chart_of_account_type, chart_of_account_view_type)
				select a.accounting_code, nextval('billing_accounting_code_seq'), 0, 0, now(), null, 'ASSETS', 'REGULAR' 
			    from 
			        (select distinct accounting_code from billing_tax where accounting_code is not null and accounting_code<>'' 
					and not exists(select * from billing_accounting_code where code=accounting_code)) a;
			]]>
		</sql>
		<sql>
			<![CDATA[update billing_tax set accounting_code_id=(select id from billing_accounting_code where code=accounting_code);]]>
		</sql>
		<sql>
			<![CDATA[
			insert into billing_accounting_code (code, id, version, disabled, created, creator, chart_of_account_type, chart_of_account_view_type)
				select a.account_code, nextval('billing_accounting_code_seq'), 0, 0, now(), null, 'ASSETS', 'REGULAR' 
			    from 
			        (select distinct account_code from ar_occ_template where account_code is not null and account_code<>'' 
					and not exists(select * from billing_accounting_code where code=account_code)) a;
			]]>
		</sql>
		<sql>
			<![CDATA[update ar_occ_template set accounting_code_id=(select id from billing_accounting_code where code=account_code);]]>
		</sql>
		<sql>
			<![CDATA[update billing_invoice_agregate set accounting_code_id=(select id from billing_accounting_code where code=accounting_code);]]>
		</sql>
		<sql>
			<![CDATA[update dwh_account_operation set accounting_code_id=(select id from billing_accounting_code where code=accounting_code);]]>
		</sql>
		<sql>
			<![CDATA[update dwh_journal_entries set accounting_code_id=(select id from billing_accounting_code where code=accounting_code);]]>
		</sql>
		<sql>
			<![CDATA[update ar_account_operation set accounting_code_id=(select id from billing_accounting_code where code=account_code);]]>
		</sql>
		
		<sql>
			<![CDATA[update billing_accounting_code set migrated=1;]]>
		</sql>
		
		<dropColumn tableName="billing_invoice_sub_cat" columnName="accounting_code"></dropColumn>
		<dropColumn tableName="billing_tax" columnName="accounting_code"></dropColumn>
		<dropColumn tableName="billing_invoice_agregate" columnName="accounting_code"></dropColumn>
		<dropColumn tableName="dwh_account_operation" columnName="accounting_code"></dropColumn>
		<dropColumn tableName="dwh_journal_entries" columnName="accounting_code"></dropColumn>
		<dropColumn tableName="ar_occ_template" columnName="account_code"></dropColumn>
		<dropColumn tableName="ar_account_operation" columnName="account_code"></dropColumn>
		
		<addUniqueConstraint columnNames="origin_id, invoice_number, accounting_code_id" constraintName="uk_og8li9rlut4trrxgajab23j7y" deferrable="false" disabled="false" initiallyDeferred="false" tableName="dwh_journal_entries" />
    </changeSet>
</databaseChangeLog>