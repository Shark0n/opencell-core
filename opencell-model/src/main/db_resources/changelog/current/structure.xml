<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.5.xsd">


    <changeSet id="#2428_20180105" author="EdwardPLegaspi">
        <addColumn tableName="adm_notif_webhooks">
            <column name="http_protocol" type="varchar(10)" />
        </addColumn>
        <sql>UPDATE ${db.schema.adapted}adm_notif_webhooks SET http_protocol='HTTP'</sql>
        <addNotNullConstraint tableName="adm_notif_webhooks" columnName="http_protocol" columnDataType="varchar(10)" />
    </changeSet>

    <changeSet id="#3170_20180119 Add payment method to invoice" author="EdwardPLegaspi">
        <addColumn tableName="billing_invoice">
            <column name="payment_method_id" type="bigint" />
        </addColumn>
    </changeSet>

    <changeSet id="#2449_20180125" author="EdwardPLegaspi">
        <addColumn tableName="cat_price_plan_matrix">
            <column name="rating_el" type="varchar(2000)" />
        </addColumn>
    </changeSet>


    <changeSet id="#3196_20180131" author="AndriusKarpavicius">
        <modifyDataType tableName="billing_charge_instance" columnName="termination_date" newDataType="datetime" />
        <modifyDataType tableName="billing_charge_instance" columnName="charge_date" newDataType="datetime" />
    </changeSet>

    <changeSet id="#2819_20180212" author="AbdelmounaimAkadid">
        <addColumn tableName="crm_seller">
            <column name="email" type="varchar(2000)" />
            <column name="fax" type="varchar(2000)" />
            <column name="mobile" type="varchar(2000)" />
            <column name="phone" type="varchar(2000)" />
        </addColumn>
    </changeSet>

    <changeSet id="#2792_20170919" author="AndriusKarpavicius">
        <sql>update ${db.schema.adapted}cat_usage_charge_template set filter_expression=null where filter_expression=''</sql>
        <sql>update ${db.schema.adapted}cat_usage_charge_template set filter_param_1=null where filter_param_1=''</sql>
        <sql>update ${db.schema.adapted}cat_usage_charge_template set filter_param_2=null where filter_param_2=''</sql>
        <sql>update ${db.schema.adapted}cat_usage_charge_template set filter_param_3=null where filter_param_3=''</sql>
        <sql>update ${db.schema.adapted}cat_usage_charge_template set filter_param_4=null where filter_param_4=''</sql>

        <sql>update ${db.schema.adapted}cat_triggered_edr set condition_el=null where condition_el=''</sql>
        <sql>update ${db.schema.adapted}cat_triggered_edr set param_1_el=null where param_1_el=''</sql>
        <sql>update ${db.schema.adapted}cat_triggered_edr set param_2_el=null where param_2_el=''</sql>
        <sql>update ${db.schema.adapted}cat_triggered_edr set param_3_el=null where param_3_el=''</sql>
        <sql>update ${db.schema.adapted}cat_triggered_edr set param_4_el=null where param_4_el=''</sql>
        <sql>update ${db.schema.adapted}cat_triggered_edr set quantity_el=null where quantity_el=''</sql>
        <sql>update ${db.schema.adapted}cat_triggered_edr set subscription_el=null where subscription_el=''</sql>
    </changeSet>


    <changeSet id="#2792_20180110" author="AndriusKarpavicius">
        <sql>update ${db.schema.adapted}cat_price_plan_matrix set criteria_1=null where criteria_1=''</sql>
        <sql>update ${db.schema.adapted}cat_price_plan_matrix set criteria_2=null where criteria_2=''</sql>
        <sql>update ${db.schema.adapted}cat_price_plan_matrix set criteria_3=null where criteria_3=''</sql>
        <sql>update ${db.schema.adapted}cat_price_plan_matrix set criteria_el=null where criteria_el=''</sql>
        <sql>update ${db.schema.adapted}cat_price_plan_matrix set amount_without_tax_el=null where amount_without_tax_el=''</sql>
        <sql>update ${db.schema.adapted}cat_price_plan_matrix set amount_with_tax_el=null where amount_with_tax_el=''</sql>

        <sql>CREATE INDEX cat_price_plan_event_c_index ON ${db.schema.adapted}cat_price_plan_matrix(event_code)</sql>
        <sql>CREATE INDEX medina_access_user_id_index ON ${db.schema.adapted}medina_access(acces_user_id)</sql>
    </changeSet>

    <changeSet id="#2792_20180119" author="AndriusKarpavicius">
        <sql>CREATE INDEX bc_instance_sub_id ON ${db.schema.adapted}billing_charge_instance(subscription_id)</sql>
        <sql>CREATE INDEX counter_period_ci_id ON ${db.schema.adapted}billing_counter_period(counter_instance_id)</sql>
        <addColumn tableName="billing_usage_charge_inst">
            <column defaultValueNumeric="1" name="priority" type="int4" />
        </addColumn>
    </changeSet>

    <changeSet id="#2792_20180119_migration_P" author="AndriusKarpavicius" dbms="postgresql">
        <sql>update ${db.schema.adapted}billing_usage_charge_inst set priority = cat_usage_charge_template.priority from ${db.schema.adapted}billing_charge_instance, ${db.schema.adapted}cat_usage_charge_template where
            billing_charge_instance.id=billing_usage_charge_inst.id and
            billing_charge_instance.charge_template_id=cat_usage_charge_template.id
        </sql>
    </changeSet>

    <changeSet id="#2792_20180119_migration_M" author="AndriusKarpavicius" dbms="mysql">
        <sql>update ${db.schema.adapted}billing_usage_charge_inst join ${db.schema.adapted}billing_charge_instance on billing_charge_instance.id=billing_usage_charge_inst.id join ${db.schema.adapted}cat_usage_charge_template on
            billing_charge_instance.charge_template_id=cat_usage_charge_template.id set billing_usage_charge_inst.priority = cat_usage_charge_template.priority
        </sql>
    </changeSet>
    
    <changeSet author="EdwardPLegaspi" id="#2370_20180306 - customer categories">
        <createTable tableName="cat_product_offer_customer_category">
            <column name="product_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="customer_category_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="indx" type="int4">
                <constraints nullable="false" />
            </column>
        </createTable>
        <addPrimaryKey columnNames="product_id, customer_category_id" constraintName="cat_product_offer_customer_category_pkey" tableName="cat_product_offer_customer_category" />
    </changeSet>

    <changeSet id="#3190_26012018_2" author="anasseh" dbms="mysql">
        <createTable tableName="ar_payment_history_seq">
            <column name="next_val" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="payment_history_seq_pk" />
            </column>
        </createTable>
        <sql>insert into ar_payment_history_seq values(1)</sql>
    </changeSet>

    <changeSet author="anasseh" id="#3190_26012018">
        <createSequence sequenceName="ar_payment_history_seq" />
        <createTable tableName="ar_payment_history">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="ar_payment_history_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="disabled" type="${type.boolean}" defaultValueNumeric="0">
                <constraints nullable="false" />
            </column>
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="customer_account_code" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="customer_account_name" type="varchar(255)" />
            <column name="seller_code" type="varchar(255)" />

            <column name="operation_date" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="last_update_date" type="datetime" />
            <column name="amount_cts" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="sync_status" type="varchar(50)">
                <constraints nullable="false" />
            </column>
            <column name="async_status" type="varchar(50)" />
            <column name="status" type="varchar(50)" />
            <column name="external_payment_id" type="varchar(255)" />
            <column name="error_code" type="varchar(255)" />
            <column name="error_message" type="varchar(2000)" />
            <column name="error_type" type="varchar(50)" />
            <column name="operation_category" type="varchar(50)">
                <constraints nullable="false" />
            </column>
            <column name="payment_gateway_code" type="varchar(255)" />
            <column name="payment_method_type" type="varchar(50)" />
            <column name="payment_method_name" type="varchar(50)" />
            <column name="payment_id" type="bigint" />
            <column name="refund_id" type="bigint" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
        </createTable>

        <addForeignKeyConstraint baseColumnNames="payment_id" baseTableName="ar_payment_history" constraintName="fk_payhisto_ao_pay" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="ar_account_operation" />

        <addForeignKeyConstraint baseColumnNames="refund_id" baseTableName="ar_payment_history" constraintName="fk_payhisto_ao_refund" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="ar_account_operation" />
    </changeSet>

    <changeSet author="anasseh" id="#3136_07022018">
        <sql>update ${db.schema.adapted}meveo_job_instance set cf_values = replace (cf_values, 'PaymentCardJob_','PaymentJob_'), job_template = replace(job_template,'PaymentCardJob','PaymentJob') </sql>
        <sql>update ${db.schema.adapted}crm_custom_field_tmpl set code = replace (code, 'PaymentCardJob_','PaymentJob_'), applies_to = replace (applies_to, 'JOB_PaymentCardJob','JOB_PaymentJob') </sql>
    </changeSet>

    <changeSet author="anasseh" id="#2830_15022018">
        <!-- account_entity -->
        <addColumn tableName="account_entity">
            <column name="address_country_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="address_country_id" baseTableName="account_entity" constraintName="fk_country_id_account" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_country" />
        <sql>update ${db.schema.adapted}account_entity ae set address_country_id = (select ac.id from ${db.schema.adapted}adm_country ac where upper(ac.description) like '%'|| upper(ae.address_country) ||'%' or
            upper(ac.description_i18n )like '%'|| upper(ae.address_country) ||'%' limit 1) </sql>
        <dropColumn tableName="account_entity" columnName="address_country" />

        <!-- com_sender_config -->
        <addColumn tableName="com_sender_config">
            <column name="address_country_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="address_country_id" baseTableName="com_sender_config" constraintName="fk_country_id_sender" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_country" />
        <sql>update ${db.schema.adapted}com_sender_config ae set address_country_id = (select ac.id from ${db.schema.adapted}adm_country ac where upper(ac.description) like '%'|| upper(ae.address_country) ||'%' or
            upper(ac.description_i18n )like '%'|| upper(ae.address_country) ||'%' limit 1) </sql>
        <dropColumn tableName="com_sender_config" columnName="address_country" />

        <!-- crm_provider_contact -->
        <addColumn tableName="crm_provider_contact">
            <column name="address_country_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="address_country_id" baseTableName="crm_provider_contact" constraintName="fk_country_id_prov_contact" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_country" />
        <sql>update ${db.schema.adapted}crm_provider_contact ae set address_country_id = (select ac.id from ${db.schema.adapted}adm_country ac where upper(ac.description) like '%'|| upper(ae.address_country) ||'%' or
            upper(ac.description_i18n )like '%'|| upper(ae.address_country) ||'%' limit 1) </sql>
        <dropColumn tableName="crm_provider_contact" columnName="address_country" />

        <!-- crm_provider -->
        <addColumn tableName="crm_provider">
            <column name="address_country_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="address_country_id" baseTableName="crm_provider" constraintName="fk_country_id_prov" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_country" />
        <sql>update ${db.schema.adapted}crm_provider ae set address_country_id = (select ac.id from ${db.schema.adapted}adm_country ac where upper(ac.description) like '%'|| upper(ae.address_country) ||'%' or upper(ac.description_i18n
            )like '%'|| upper(ae.address_country) ||'%' limit 1) </sql>
        <dropColumn tableName="crm_provider" columnName="address_country" />

        <!-- crm_seller -->
        <addColumn tableName="crm_seller">
            <column name="address_country_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="address_country_id" baseTableName="crm_seller" constraintName="fk_country_id_seller" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_country" />
        <sql>update ${db.schema.adapted}crm_seller ae set address_country_id = (select ac.id from ${db.schema.adapted}adm_country ac where upper(ac.description) like '%'|| upper(ae.address_country) ||'%' or upper(ac.description_i18n
            )like '%'|| upper(ae.address_country) ||'%' limit 1) </sql>
        <dropColumn tableName="crm_seller" columnName="address_country" />

        <!-- ord_order_item -->
        <addColumn tableName="ord_order_item">
            <column name="address_country_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="address_country_id" baseTableName="ord_order_item" constraintName="fk_country_id_order" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_country" />
        <sql>update ${db.schema.adapted}ord_order_item ae set address_country_id = (select ac.id from ${db.schema.adapted}adm_country ac where upper(ac.description) like '%'|| upper(ae.address_country) ||'%' or
            upper(ac.description_i18n )like '%'|| upper(ae.address_country) ||'%' limit 1) </sql>
        <dropColumn tableName="ord_order_item" columnName="address_country" />
    </changeSet>

    <changeSet id="#2875_20171201" author="anasseh">
        <addColumn tableName="ar_payment_gateway">
            <column name="country_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="country_id" baseTableName="ar_payment_gateway" constraintName="fk_paygw_country" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_country" />

        <addColumn tableName="ar_payment_gateway">
            <column name="nb_tries" type="int" />
            <column name="replay_cause" type="varchar(100)" />
            <column name="errors_to_replay" type="varchar(400)" />
        </addColumn>
    </changeSet>

    <changeSet id="#2875_20171201-M" author="anasseh" dbms="mysql">
        <dropForeignKeyConstraint baseTableName="ar_payment_gateway" constraintName="fk_paygw_trad_country"/>
        <dropIndex tableName="ar_payment_gateway" indexName="fk_paygw_trad_country"/>
    </changeSet>

    <changeSet id="#2875_20171201-End" author="anasseh">
        <dropColumn tableName="ar_payment_gateway" columnName="trading_country_id" />
    </changeSet>
    
    <changeSet id="#2870_20180129" author="EdwardLegaspi">
        <createTable tableName="dwh_report_extract">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="dwh_report_extract_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="disabled" type="${type.boolean}" defaultValueNumeric="0">
                <constraints nullable="false" />
            </column>
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="code" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="description" type="varchar(255)" />
            <column name="category" type="varchar(50)" />
            <column name="script_type" type="varchar(10)">
            	<constraints nullable="false"/>
           	</column>
            <column name="filename_format" type="varchar(100)">
            	<constraints nullable="false"/>
            </column>
            <column name="sql_query" type="varchar(2000)" />
            <column name="script_instance_id" type="bigint" />
		</createTable>
		
		<addForeignKeyConstraint baseColumnNames="script_instance_id" baseTableName="dwh_report_extract" constraintName="fk_report_extract_script_instance" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="meveo_script_instance" />
		<createSequence sequenceName="dwh_report_extract_seq" />
		
		<createTable tableName="dwh_report_extract_params">
            <column name="reportextract_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="params" type="varchar(255)" />
            <column name="params_key" type="varchar(255)">
                <constraints nullable="false" />
            </column>
        </createTable>
        <addPrimaryKey columnNames="reportextract_id, params_key" constraintName="pk_report_extract_params" tableName="dwh_report_extract_params" />
    </changeSet>
        
</databaseChangeLog> 