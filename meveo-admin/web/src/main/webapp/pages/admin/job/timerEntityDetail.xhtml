<ui:composition xmlns="http://www.w3.org/1999/xhtml" xmlns:ui="http://java.sun.com/jsf/facelets" xmlns:f="http://java.sun.com/jsf/core"
    xmlns:h="http://java.sun.com/jsf/html" xmlns:hftl="http://hftl.org"
    xmlns:hf="http://java.sun.com/jsf/composite/tags" xmlns:s="http://jboss.org/seam/faces"
    xmlns:sc="http://java.sun.com/jsf/composite/components/seamfaces" xmlns:p="http://primefaces.org/ui" template="/layout/template.xhtml"
    xmlns:e="http://primefaces.org/extension">

    <ui:define name="navigation">
        <ui:include src="/layout/navigation.xhtml" />
    </ui:define>

    <f:metadata>
        <f:event type="preRenderView" listener="#{timerEntityBean.preRenderView}" />
    </f:metadata>

    <ui:param name="pageTitle" value="#{messages['job.page.title']}" />
    <ui:define name="body">

        <p:panel>
            <f:facet name="header">
                <h:outputText value="#{messages['job.page.title']}" />
            </f:facet>

            <hf:formPanel formId="timerBeanFormId" backingBean="#{timerEntityBean}">


                <hf:formDecorateField fieldId="jobCategory" label="#{messages['timer.jobCategory']}" >
                    <p:selectOneMenu id="jobCategory" value="#{timerEntityBean.entity.jobCategoryEnum}" required="true"
                        rendered="#{timerEntityBean.entity.id==null}">
                        <f:selectItem itemLabel="#{messages['commons.select']}" />
                        <f:selectItems value="#{timerEntityBean.jobCategoryEnumValues}" var="jobCat" itemLabel="#{messages[jobCat.label]}" />
                        <p:ajax event="valueChange" update="@form"></p:ajax>
                    </p:selectOneMenu>
                    <h:outputText value="#{messages[timerEntityBean.entity.jobCategoryEnum.label]}" rendered="#{timerEntityBean.entity.id!=null}" />
                </hf:formDecorateField>


                <hf:formDecorateField fieldId="timerJobName" label="#{messages['timer.jobName']}" >
                    <p:selectOneMenu id="timerJobName" value="#{timerEntityBean.entity.jobName}" rendered="#{timerEntityBean.entity.id == null}"
                        required="true">
                        <f:selectItem itemLabel="#{messages['commons.select']}" />
                        <f:selectItems value="#{timerEntityBean.jobNames}" />
                        <p:ajax event="valueChange" listener="#{timerEntityBean.initCustomFields}" update="@form"></p:ajax>
                    </p:selectOneMenu>
                    <h:outputText value="#{timerEntityBean.entity.jobName}" rendered="#{timerEntityBean.entity.id!=null}" />
                </hf:formDecorateField>

                <hf:formField label="#{messages['timer.name']}" field="name" required="true" />

                <hf:formDecorateField fieldId="timerFollowingJob" label="#{messages['timer.followingJob']}" >
                    <p:selectOneMenu id="timerFollowingJob" value="#{timerEntityBean.entity.timerInfo.followingTimerId}"
                        rendered="#{timerEntityBean.edit}">
                        <f:selectItem itemLabel="#{messages['commons.select']}" />
                        <f:selectItems value="#{timerEntityBean.getTimerEntityList()}" var="t_" itemLabel="#{t_.name}" itemValue="#{t_.id}" />
                    </p:selectOneMenu>
                    <h:outputText value="#{timerEntityBean.translateToTimerName(timerEntityBean.entity.timerInfo.followingTimerId)}"
                        rendered="#{!timerEntityBean.edit}" />
                </hf:formDecorateField>
                
                <p:fieldset legend="#{messages['timer.schedule']}" layout="block" rendered="#{timerEntityBean.entity.id!=null or timerEntityBean.entity.jobName!=null}" styleClass="clearLeft">
                    <hf:formField label="#{messages['timer.hour']}" field="hour" required="true" />
                    <hf:formField label="#{messages['timer.minute']}" field="minute" required="true" />
                    <hf:formField label="#{messages['timer.second']}" field="second" required="true" />
                    <hf:formField label="#{messages['timer.year']}" field="year" required="true" />
                    <hf:formField label="#{messages['timer.month']}" field="month" required="true" />
                    <hf:formField label="#{messages['timer.dayOfMonth']}" field="dayOfMonth" required="true" />
                    <hf:formField label="#{messages['timer.dayOfWeek']}" field="dayOfWeek" required="true" />
                    <hf:formField label="#{messages['timer.parameter']}" field="timerInfo" childField="parametres" />
                    
                    <h:outputLink value="http://docs.oracle.com/javaee/6/api/javax/ejb/ScheduleExpression.html" target="_blank" styleClass="clearLeft">Help on format</h:outputLink>
                </p:fieldset>
                
                
                <hf:formField label="#{messages['timer.active']}" field="timerInfo" childField="active" />


                <p:fieldset legend="#{messages['customFieldTemplate.panel']}" styleClass="clearLeft" rendered="#{! empty(timerEntityBean.customFieldTemplates)}">
                    <hf:customFields />
                </p:fieldset>

                <h:panelGroup layout="block" styleClass="form-panel-actions">
                    <!--  <div class="action-buttons">
                            <p:commandButton ajax="false" id="button_create"
                                value="#{messages['action.save']}"
                                action="#{timerEntityBean.create()}"
                                rendered="#{timerEntityBean.entity.id==null and timerEntityBean.entity.jobName!=null}" />
                            <p:commandButton ajax="false" id="button_update"
                                value="#{messages['action.save']}"
                                action="#{timerEntityBean.updateTimer()}"
                                rendered="#{timerEntityBean.entity.id!=null}" />
                            <p:commandButton ajax="false" id="button_delete"
                                value="#{messages['commons.delete']}"
                                action="#{timerBean.deleteTimer()}" immediate="true"
                                onclick="if(!confirm('#{messages['entity.remove.confirmation']}')) return false;"
                                rendered="#{timerBean.timerEntity.id!=null }" />
                            <p:commandButton ajax="false" id="button_execute"
                                value="#{messages['job.executeJobNow']}"
                                action="#{timerBean.executeTimer()}"
                                rendered="#{timerBean.timerEntity.id!=null}" />
                            <p:button id="button_back" value="#{messages['action.back']}"
                                outcome="jobTimers" />
                        </div>
                        -->
                    <p:commandButton ajax="false" id="button_execute" value="#{messages['job.executeJobNow']}"
                        action="#{timerEntityBean.executeTimer()}" rendered="#{timerEntityBean.entity.id!=null}" />
                </h:panelGroup>
            </hf:formPanel>


            <!-- ===================================== JOB EXECUTION RESULTS ===================================== -->

            <p:outputPanel id="jobExecutions">
                <p:dataTable id="jobExecutionsDatatable" var="entity" paginator="true" value="#{timerEntityBean.getJobExecutionList()}" rows="10"
                    rowKey="#{entity.id}" widget="jobExecutionsTable">
                    <p:column sortBy="#{entity.startDate}">
                        <f:facet name="header">
                            <h:outputText value="#{messages['jobExecution.startDate']}" />
                        </f:facet>
                        <h:outputText value="#{entity.startDate}">
                            <f:convertDateTime pattern="dd/MM/yyyyy hh:mm:ss" />
                        </h:outputText>
                    </p:column>

                    <p:column sortBy="#{entity.endDate}">
                        <f:facet name="header">
                            <h:outputText value="#{messages['jobExecution.endDate']}" />
                        </f:facet>
                        <h:outputText value="#{entity.endDate}">
                            <f:convertDateTime pattern="dd/MM/yyyyy hh:mm:ss" />
                        </h:outputText>
                    </p:column>

                    <p:column sortBy="#{entity.nbItemsCorrectlyProcessed}">
                        <f:facet name="header">
                            <h:outputText value="#{messages['jobExecution.nbOk']}" />
                        </f:facet>
                        <h:outputText value="#{entity.nbItemsCorrectlyProcessed}">
                        </h:outputText>
                    </p:column>

                    <p:column sortBy="#{entity.nbItemsProcessedWithWarning}">
                        <f:facet name="header">
                            <h:outputText value="#{messages['jobExecution.nbWarn']}" />
                        </f:facet>
                        <h:outputText value="#{entity.nbItemsProcessedWithWarning}">
                        </h:outputText>
                    </p:column>

                    <p:column sortBy="#{entity.nbItemsProcessedWithError}">
                        <f:facet name="header">
                            <h:outputText value="#{messages['jobExecution.nbKo']}" />
                        </f:facet>
                        <h:outputText value="#{entity.nbItemsProcessedWithError}">
                        </h:outputText>
                    </p:column>

                    <p:column sortBy="#{entity.report}">
                        <f:facet name="header">
                            <h:outputText value="#{messages['jobExecution.report']}" />
                        </f:facet>
                        <h:outputText value="#{entity.report}">
                        </h:outputText>
                    </p:column>

                </p:dataTable>
            </p:outputPanel>
        </p:panel>
    </ui:define>
</ui:composition>
