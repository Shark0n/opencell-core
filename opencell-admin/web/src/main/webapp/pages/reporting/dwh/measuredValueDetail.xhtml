<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:hftl="http://hftl.org"
                xmlns:hf="http://xmlns.jcp.org/jsf/composite/tags"
                xmlns:c="http://xmlns.jcp.org/jsp/jstl/core"
                xmlns:p="http://primefaces.org/ui" template="/layout/template.xhtml">


    <ui:define name="metadata">
        <f:metadata>
            <f:event type="preRenderView" listener="#{measurementBean.preRenderView}"/>
        </f:metadata>
    </ui:define>

    <ui:define name="body">

        <c:set var="renderDimension1" value="#{measurementBean.dimension1Filter != 'null'}"/>
        <c:set var="renderDimension2" value="#{measurementBean.dimension2Filter != 'null'}"/>
        <c:set var="renderDimension3" value="#{measurementBean.dimension3Filter != 'null'}"/>
        <c:set var="renderDimension4" value="#{measurementBean.dimension4Filter != 'null'}"/>
        <c:set var="hasMeasurableQuantity" value="#{measurementBean.measurableQuantity != null}"/>


        hasMeasurableQuantity: <h:outputText value="#{hasMeasurableQuantity}"/>

        <h:form id="crumbmenuForm">
            <p:breadCrumb homeDisplay="text" id="crumbmenu">
                <p:menuitem value="#{messages['menu.reporting']}" disabled="true"/>
                <p:menuitem outcome="measuredValueDetail" value="#{messages['menu.measuredValues']}"/>
            </p:breadCrumb>
        </h:form>

        <hftl:decorateFormPanel formId="measurementForm" label="#{messages['page.title.measuredValue']}">
            <ui:define name="fields">
                <hftl:decorateFormField fieldId="measurableQuantityCode" label="#{messages['entity.measuredvalue.measurableQuantityCode']}">
                    <p:selectOneMenu id="measurableQuantityCode" required="true"
                                     value="#{measurementBean.measurableQuantityCode}"
                                     converter="omnifaces.SelectItemsConverter" style="width: 150px">
                        <f:selectItem itemLabel="" itemValue=""/>
                        <f:selectItems value="#{measurementBean.getMeasurableQuantityCodes()}"
                                       var="obj" itemValue="#{obj}" itemLabel="#{obj}"/>
                        <p:ajax event="valueChange" update=":measurementForm :mqTableForm"/>
                    </p:selectOneMenu>
                </hftl:decorateFormField>

                <hftl:decorateFormField fieldId="measurablePeriod" label="#{messages['entity.measuredvalue.measurementPeriod']}"
                                        rendered="#{measurementBean.measurableQuantity != null}">
                    <p:selectOneMenu id="measurablePeriod" required="true"
                                     value="#{measurementBean.measuredPeriod}"
                                     converter="omnifaces.SelectItemsConverter" style="width: 150px">
                        <f:selectItem itemLabel="" itemValue=""/>
                        <f:selectItems value="#{measurementBean.getMeasurePeriods()}"
                                       var="obj" itemValue="#{obj}"
                                       itemLabel="#{messages['enum.measurementperiod.'.concat(obj)]}"/>
                        <p:ajax event="valueChange" update=":measurementForm :mqTableForm"/>
                    </p:selectOneMenu>
                </hftl:decorateFormField>

                <hftl:decorateFormField fieldId="selectedDate" label="#{messages['commons.date']}" rendered="#{hasMeasurableQuantity}">
                    <p:calendar id="selectedDate"
                                value="#{measurementBean.selectedDate}" required="true"
                                pattern="MMMM yyyy">
                    </p:calendar>
                </hftl:decorateFormField>


                <h:panelGroup id="dimensions" rendered="#{hasMeasurableQuantity}">
                    <hftl:decorateFormField fieldId="dimension1Filter" label="#{messages['entity.measurablequantity.dimension1']}" newLine="true" rendered="#{renderDimension1}">
                        <p:selectOneMenu id="dimension1Filter"
                                         value="#{measurementBean.dimension1Filter}"
                                         converter="omnifaces.SelectItemsConverter"
                                         rendered="#{not hasMeasurableQuantity}">
                            <f:selectItem itemLabel="" itemValue=""/>
                            <f:selectItems value="#{measurementBean.getDimensionList(1)}"
                                           var="obj" itemValue="#{obj}"/>
                            <p:ajax event="valueChange" update=":measurementForm"/>
                        </p:selectOneMenu>
                        <h:outputText value="#{measurementBean.dimension1Filter}"
                                      rendered="#{hasMeasurableQuantity}"/>
                    </hftl:decorateFormField>

                    <hftl:decorateFormField fieldId="dimension2Filter" label="#{messages['entity.measurablequantity.dimension2']}" rendered="#{renderDimension2}">
                        <p:selectOneMenu id="dimension2Filter"
                                         value="#{measurementBean.dimension2Filter}"
                                         converter="omnifaces.SelectItemsConverter"
                                         rendered="#{not hasMeasurableQuantity}">
                            <f:selectItem itemLabel="" itemValue=""/>
                            <f:selectItems value="#{measurementBean.getDimensionList(1)}"
                                           var="obj" itemValue="#{obj}"/>
                            <p:ajax event="valueChange" update=":measurementForm"/>
                        </p:selectOneMenu>
                        <h:outputText value="#{measurementBean.dimension2Filter}"
                                      rendered="#{hasMeasurableQuantity}"/>
                    </hftl:decorateFormField>

                    <hftl:decorateFormField fieldId="dimension3Filter" label="#{messages['entity.measurablequantity.dimension3']}" rendered="#{renderDimension3}">
                        <p:selectOneMenu id="dimension3Filter"
                                         value="#{measurementBean.dimension3Filter}"
                                         converter="omnifaces.SelectItemsConverter"
                                         rendered="#{not hasMeasurableQuantity}">
                            <f:selectItem itemLabel="" itemValue=""/>
                            <f:selectItems value="#{measurementBean.getDimensionList(1)}"
                                           var="obj" itemValue="#{obj}"/>
                            <p:ajax event="valueChange" update=":measurementForm"/>
                        </p:selectOneMenu>
                        <h:outputText value="#{measurementBean.dimension3Filter}"
                                      rendered="#{hasMeasurableQuantity}"/>
                    </hftl:decorateFormField>

                    <hftl:decorateFormField fieldId="dimension4Filter" label="#{messages['entity.measurablequantity.dimension4']}" rendered="#{renderDimension4}">
                        <p:selectOneMenu id="dimension4Filter"
                                         value="#{measurementBean.dimension4Filter}"
                                         converter="omnifaces.SelectItemsConverter"
                                         rendered="#{not hasMeasurableQuantity}">
                            <f:selectItem itemLabel="" itemValue=""/>
                            <f:selectItems value="#{measurementBean.getDimensionList(1)}"
                                           var="obj" itemValue="#{obj}"/>
                            <p:ajax event="valueChange" update=":measurementForm"/>
                        </p:selectOneMenu>
                        <h:outputText value="#{measurementBean.dimension4Filter}"
                                      rendered="#{hasMeasurableQuantity}"/>
                    </hftl:decorateFormField>
                </h:panelGroup>
            </ui:define>
            <ui:define name="buttons">
                <p:commandButton value="Display Table"
                                 action="#{measurementBean.generateMVModel()}"
                                 update=":mqTableForm"
                                 rendered="#{hasMeasurableQuantity and (measurementBean.measuredPeriod != null)}"/>
            </ui:define>
        </hftl:decorateFormPanel>

        <h:form id="mqTableForm">
            <p:dataTable id="mqTable" value="#{measurementBean.mainMVModel}"
                         var="mv" rendered="#{measurementBean.mainMVModel != null}" resizableColumns="true"
                         editable="#{measurementBean.measurableQuantity.editable}" editMode="cell">

                <p:ajax event="cellEdit" listener="#{measurementBean.onCellEdit}"/>

                <p:columnGroup type="header">
                    <p:row>
                        <p:column headerText="#{messages['commons.date']}"/>
                        <p:column headerText="#{messages['commons.value']}"/>
                        <p:column headerText="#{measurementBean.dimension1Filter}" rendered="#{renderDimension1}"/>
                        <p:column headerText="#{measurementBean.dimension2Filter}" rendered="#{renderDimension2}"/>
                        <p:column headerText="#{measurementBean.dimension3Filter}" rendered="#{renderDimension3}"/>
                        <p:column headerText="#{measurementBean.dimension4Filter}" rendered="#{renderDimension4}"/>
                    </p:row>
                </p:columnGroup>

                <p:column styleClass="ui-editable-column" id="date">
                    <h:outputText value="#{mv.date}">
                        <f:convertDateTime pattern="#{paramBean.dateFormat}"/>
                    </h:outputText>
                </p:column>

                <p:column styleClass="ui-editable-column" id="value">
                    <h:outputText value="#{mv.value}"
                                  rendered="#{not measurementBean.measurableQuantity.editable}"/>
                    <p:cellEditor rendered="#{measurementBean.measurableQuantity.editable}">
                        <f:facet name="output">
                            <h:outputText value="#{mv.value}" converter="bigDecimal4DigitsConverter"/>
                        </f:facet>
                        <f:facet name="input">
                            <p:inputText value="#{mv.value}"/>
                        </f:facet>
                    </p:cellEditor>
                </p:column>
                <p:column styleClass="ui-editable-column" id="dimension1" rendered="#{renderDimension1}">
                    <h:outputText value="#{mv.dimension1}"
                                  rendered="#{not measurementBean.measurableQuantity.editable}">
                        <f:convertNumber pattern="#0.0000"/>
                    </h:outputText>
                    <p:cellEditor rendered="#{measurementBean.measurableQuantity.editable}">
                        <f:facet name="output">
                            <h:outputText value="#{mv.dimension1}">
                                <f:convertNumber pattern="#0.0000"/>
                            </h:outputText>
                        </f:facet>
                        <f:facet name="input">
                            <p:inputText value="#{mv.dimension1}"/>
                        </f:facet>
                    </p:cellEditor>
                </p:column>
                <p:column styleClass="ui-editable-column" id="dimension2" rendered="#{renderDimension2}">
                    <h:outputText value="#{mv.dimension2}"
                                  rendered="#{not measurementBean.measurableQuantity.editable}">
                        <f:convertNumber pattern="#0.0000"/>
                    </h:outputText>
                    <p:cellEditor rendered="#{measurementBean.measurableQuantity.editable}">
                        <f:facet name="output">
                            <h:outputText value="#{mv.dimension2}">
                                <f:convertNumber pattern="#0.0000"/>
                            </h:outputText>
                        </f:facet>
                        <f:facet name="input">
                            <p:inputText value="#{mv.dimension2}"/>
                        </f:facet>
                    </p:cellEditor>
                </p:column>
                <p:column styleClass="ui-editable-column" id="dimension3" rendered="#{renderDimension3}">
                    <h:outputText value="#{mv.dimension3}"
                                  rendered="#{not measurementBean.measurableQuantity.editable}">
                        <f:convertNumber pattern="#0.0000"/>
                    </h:outputText>
                    <p:cellEditor rendered="#{measurementBean.measurableQuantity.editable}">
                        <f:facet name="output">
                            <h:outputText value="#{mv.dimension3}">
                                <f:convertNumber pattern="#0.0000"/>
                            </h:outputText>
                        </f:facet>
                        <f:facet name="input">
                            <p:inputText value="#{mv.dimension3}"/>
                        </f:facet>
                    </p:cellEditor>
                </p:column>
                <p:column styleClass="ui-editable-column" id="dimension4" rendered="#{renderDimension4}">
                    <h:outputText value="#{mv.dimension4}"
                                  rendered="#{not measurementBean.measurableQuantity.editable}">
                        <f:convertNumber pattern="#0.0000"/>
                    </h:outputText>
                    <p:cellEditor rendered="#{measurementBean.measurableQuantity.editable}">
                        <f:facet name="output">
                            <h:outputText value="#{mv.dimension4}">
                                <f:convertNumber pattern="#0.0000"/>
                            </h:outputText>
                        </f:facet>
                        <f:facet name="input">
                            <p:inputText value="#{mv.dimension4}"/>
                        </f:facet>
                    </p:cellEditor>
                </p:column>
            </p:dataTable>

            <p:panel styleClass="form-panel-actions">
                <h:commandLink rendered="#{measurementBean.mainMVModel != null}">
                    <h:outputText value="#{messages['page.measuredValue.exporttable']}"/>
                    <p:dataExporter type="xls" target="mqTable"
                                    fileName="measuredValueTable"
                                    postProcessor="#{measurementBean.generateExcelReport}"/>
                </h:commandLink>
            </p:panel>
        </h:form>


        <p:dialog id="editMV" header="#{messages['menu.measuredValues']}"
                  showEffect="fade" widgetVar="editMVWidget" modal="true"
                  appendTo="@(body)">
            <h:form id="editMVdialog">
                <p:panelGrid columns="2">
                    <p:outputLabel for="mvdate"
                                   value="#{messages['entity.measuredvalue.date']}"/>
                    <h:outputText id="mvdate"
                                  value="#{measurementBean.selectedMV.date}" styleClass="value">
                        <f:convertDateTime pattern="#{paramBean.dateFormat}"/>
                    </h:outputText>
                    <p:outputLabel for="mvPeriod"
                                   value="#{messages['entity.measuredvalue.measurementPeriod']}"/>
                    <h:outputText id="mvPeriod"
                                  value="#{messages['enum.measurementperiod.'.concat(measurementBean.selectedMV.measurementPeriod)]}"
                                  styleClass="value">
                    </h:outputText>
                    <p:outputLabel for="mvvalue"
                                   value="#{messages['entity.measuredvalue.value']}"/>
                    <p:inputText id="mvvalue"
                                 value="#{measurementBean.selectedMV.value}"/>
                    <p:commandButton value="#{messages['action.save']}"
                                     action="#{measurementBean.saveMV}" ajax="false"/>
                </p:panelGrid>
            </h:form>
        </p:dialog>

    </ui:define>

</ui:composition>
