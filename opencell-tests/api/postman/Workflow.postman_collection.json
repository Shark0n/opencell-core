{
	"info": {
		"_postman_id": "62dbf2d2-2f66-4536-8e9b-5ddf4f307c24",
		"name": "Workflow",
		"schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
	},
	"item": [
		{
			"name": "Dunning workflow",
			"item": [
				{
					"name": "Setup",
					"item": [
						{
							"name": "script|code=SimpleDunning|desc=handles simple dunning transitions",
							"event": [
								{
									"listen": "test",
									"script": {
										"id": "f93c9c9e-0e88-40c6-9e84-b10502c55e2e",
										"exec": [
											"var jsonData = JSON.parse(responseBody);",
											"tests[\"is.success\"] = jsonData.actionStatus.status === \"SUCCESS\";",
											"tests[\"is.compiled\"] = jsonData.compilationErrors.length === 0;",
											""
										],
										"type": "text/javascript"
									}
								}
							],
							"request": {
								"method": "POST",
								"header": [
									{
										"key": "Content-Type",
										"value": "application/xml"
									}
								],
								"body": {
									"mode": "raw",
									"raw": "<ScriptInstance>\r\n        <code>org.meveo.service.script.SimpleDunning</code>\r\n        <description>{{script_desc}} {{$timestamp}}</description>\r\n        <type>JAVA</type>\r\n        <script><![CDATA[\r\n            package org.meveo.service.script;\r\n\r\n            import org.meveo.model.generic.wf.WFStatus;\r\n            import org.meveo.model.generic.wf.WorkflowInstance;\r\n            import org.meveo.model.payments.AccountOperation;\r\n            import org.meveo.model.payments.CustomerAccount;\r\n            import org.meveo.model.payments.DunningLevelEnum;\r\n            import org.meveo.service.payments.impl.CustomerAccountService;\r\n            import org.slf4j.Logger;\r\n            import org.slf4j.LoggerFactory;\r\n\r\n            import java.util.Map;\r\n\r\n            import static org.meveo.admin.job.GenericWorkflowJob.*;\r\n\r\n            public class SimpleDunning extends org.meveo.service.script.Script {\r\n\r\n                private static final Logger log = LoggerFactory.getLogger(SimpleDunning.class);\r\n\r\n                private CustomerAccountService customerAccountService = (CustomerAccountService) getServiceInterface(\"CustomerAccountService\");\r\n\r\n                @Override\r\n                public void execute(Map<String, Object> context) {\r\n                    log.info(\">>> Method context >>>\");\r\n                    context.entrySet().stream().sorted(Map.Entry.comparingByKey()).forEach(entry -> {\r\n                        log.info(\"{}={}\", entry.getKey(), entry.getValue());\r\n                    });\r\n\r\n                    WorkflowInstance workflowInstance = (WorkflowInstance) context.get(WF_INS);\r\n                    CustomerAccount customerAccount = (CustomerAccount) context.get(IWF_ENTITY);\r\n                    WFStatus wfToStatus = (WFStatus) context.get(TO_STATUS);\r\n\r\n                    if (\"R0\".equals(workflowInstance.getCurrentStatus().getCode()) && \"R1\".equals(wfToStatus.getCode())) {\r\n                        customerAccountService.sendEmailAndUpdateDunningLevel(customerAccount, DunningLevelEnum.R1);\r\n                    } else if (\"R0\".equals(wfToStatus.getCode())) {\r\n                        customerAccountService.sendEmailAndUpdateDunningLevel(customerAccount, DunningLevelEnum.R0);\r\n                    }\r\n                }\r\n            }\r\n]]></script>\r\n</ScriptInstance>",
									"options": {
										"raw": {
											"language": "xml"
										}
									}
								},
								"url": {
									"raw": "{{opencell.url}}/scriptInstance/createOrUpdate",
									"host": [
										"{{opencell.url}}"
									],
									"path": [
										"scriptInstance",
										"createOrUpdate"
									]
								}
							},
							"response": []
						},
						{
							"name": "workflow|code=WF_DUNNING_SIMPLE|class=org.meveo.model.payments.CustomerAccount|desc=Simple dunning workflow",
							"event": [
								{
									"listen": "test",
									"script": {
										"id": "b96b8ac6-8a21-4ce9-8e90-5e784c9239d0",
										"exec": [
											"var jsonData = JSON.parse(responseBody);",
											"tests[\"is.success\"] = jsonData.status === \"SUCCESS\";"
										],
										"type": "text/javascript"
									}
								},
								{
									"listen": "prerequest",
									"script": {
										"id": "d5e2b5ff-6de2-4d49-9b26-c9991ba355a3",
										"exec": [
											""
										],
										"type": "text/javascript"
									}
								}
							],
							"request": {
								"method": "POST",
								"header": [
									{
										"key": "Content-Type",
										"type": "text",
										"value": "application/json"
									},
									{
										"key": "Accept",
										"type": "text",
										"value": "application/json"
									}
								],
								"body": {
									"mode": "raw",
									"raw": "{\r\n    \"code\": \"{{code}}\",\r\n    \"description\": \"{{desc}}\",\r\n    \"disabled\": false,\r\n    \"targetEntityClass\": \"{{class}}\",\r\n    \"initStatus\": \"R0\",\r\n    \"enableHistory\": true,\r\n    \"status\": [\r\n        {\r\n            \"code\": \"R0\",\r\n            \"description\": \"No dunning\"\r\n        },\r\n        {\r\n            \"code\": \"R1\",\r\n            \"description\": \"Reminder email sent\"\r\n        },\r\n        {\r\n            \"code\": \"R2\",\r\n            \"description\": \"Account suspended\"\r\n        },\r\n        {\r\n            \"code\": \"R3\",\r\n            \"description\": \"Dunning file sent to external company\"\r\n        }\r\n    ],\r\n    \"transition\": [\r\n        {\r\n            \"fromStatus\": \"R0\",\r\n            \"toStatus\": \"R1\",\r\n            \"conditionEl\": \"#{mv:getBean('CustomerAccountService').customerAccountBalanceDue(entity.id)  > 0}\",\r\n            \"priority\": 2,\r\n            \"description\": \"Some amount is due\",\r\n            \"actionScriptCode\": \"org.meveo.service.script.SimpleDunning\"\r\n        },\r\n        {\r\n            \"fromStatus\": \"R1\",\r\n            \"toStatus\": \"R0\",\r\n            \"conditionEl\": \"#{mv:getBean('CustomerAccountService').customerAccountBalanceDue(entity.id)  <= 0}\",\r\n            \"priority\": 1,\r\n            \"description\": \"All is fine again\",\r\n            \"actionScriptCode\": \"org.meveo.service.script.SimpleDunning\"\r\n        },\r\n        {\r\n            \"fromStatus\": \"R1\",\r\n            \"toStatus\": \"R2\",\r\n            \"conditionEl\": \"#{ false }\",\r\n            \"priority\": 3,\r\n            \"description\": \"Time is up\",\r\n            \"actionScriptCode\": \"org.meveo.service.script.SimpleDunning\"\r\n        },\r\n        {\r\n            \"fromStatus\": \"R2\",\r\n            \"toStatus\": \"R3\",\r\n            \"conditionEl\": \"#{ false }\",\r\n            \"priority\": 4,\r\n            \"description\": \"Debt collector is in\",\r\n            \"actionScriptCode\": \"org.meveo.service.script.SimpleDunning\"\r\n        }\r\n    ]\r\n}"
								},
								"url": {
									"raw": "{{opencell.url}}/admin/genericWorkflow/createOrUpdate",
									"host": [
										"{{opencell.url}}"
									],
									"path": [
										"admin",
										"genericWorkflow",
										"createOrUpdate"
									]
								}
							},
							"response": []
						},
						{
							"name": "job|Workflow|code=WF_DUNNING_SIMPLE",
							"event": [
								{
									"script": {
										"type": "text/javascript",
										"id": "1fa98348-a95d-4668-a9a1-62304c3e5c06",
										"exec": [
											"var jsonData = JSON.parse(responseBody);",
											"tests[\"is.success\"] = jsonData.status === \"SUCCESS\";"
										]
									},
									"listen": "test"
								}
							],
							"request": {
								"method": "POST",
								"header": [
									{
										"value": "application/json",
										"key": "Content-Type"
									}
								],
								"body": {
									"mode": "raw",
									"raw": "{\r\n    \"code\": \"{{code}}_JOB\",\r\n    \"disabled\": false,\r\n    \"jobCategory\": \"UTILS\",\r\n    \"jobTemplate\": \"GenericWorkflowJob\",\r\n    \"active\": true,\r\n    \"customFields\": {\r\n        \"customField\": [\r\n            {\r\n                \"code\": \"gwfJob_nbRuns\",\r\n                \"longValue\": 1\r\n            },\r\n            {\r\n                \"code\": \"gwfJob_waitingMillis\",\r\n                \"longValue\": 0\r\n            },\r\n            {\r\n                \"code\": \"gwfJob_generic_wf\",\r\n                \"entityReferenceValue\": {\r\n                    \"classname\": \"org.meveo.model.generic.wf.GenericWorkflow\",\r\n                    \"classnameCode\": null,\r\n                    \"code\": \"{{code}}\"\r\n                }\r\n            }\r\n        ]\r\n    },\r\n    \"limitToSingleNode\": true,\r\n    \"verboseReport\": true\r\n}"
								},
								"url": {
									"raw": "{{opencell.url}}/job/createOrUpdate",
									"host": [
										"{{opencell.url}}"
									],
									"path": [
										"job",
										"createOrUpdate"
									]
								}
							},
							"response": []
						}
					],
					"protocolProfileBehavior": {},
					"_postman_isSubFolder": true
				},
				{
					"name": "Run",
					"item": [
						{
							"name": "job/execute|code=WF_DUNNING_SIMPLE_JOB",
							"event": [
								{
									"script": {
										"id": "bdfe9d5c-cdf2-4883-9125-9b2fd8c422da",
										"exec": [
											"var jsonData = JSON.parse(responseBody);",
											"tests[\"is.success\"] = jsonData.actionStatus.status === \"SUCCESS\";",
											"",
											"pm.globals.set(\"jobRun.id\", jsonData.actionStatus.message);"
										],
										"type": "text/javascript"
									},
									"listen": "test"
								}
							],
							"request": {
								"method": "POST",
								"header": [
									{
										"value": "application/json",
										"key": "Content-Type"
									}
								],
								"body": {
									"mode": "raw",
									"raw": "{\n  \"code\":\"{{code}}_JOB\"\n}"
								},
								"url": {
									"raw": "{{opencell.url}}/job/execute",
									"host": [
										"{{opencell.url}}"
									],
									"path": [
										"job",
										"execute"
									]
								}
							},
							"response": []
						}
					],
					"protocolProfileBehavior": {},
					"_postman_isSubFolder": true
				}
			],
			"protocolProfileBehavior": {}
		}
	],
	"auth": {
		"type": "basic",
		"basic": [
			{
				"key": "password",
				"value": "{{opencell.password}}",
				"type": "string"
			},
			{
				"key": "username",
				"value": "{{opencell.username}}",
				"type": "string"
			}
		]
	},
	"event": [
		{
			"listen": "prerequest",
			"script": {
				"id": "3342d779-37d6-479b-bbdc-1df0a49e2ff5",
				"type": "text/javascript",
				"exec": [
					""
				]
			}
		},
		{
			"listen": "test",
			"script": {
				"id": "897c94c0-ecc5-4a79-86eb-ab3d71356a64",
				"type": "text/javascript",
				"exec": [
					""
				]
			}
		}
	],
	"variable": [
		{
			"id": "6ee0402f-74d6-4fb1-98a9-dd82f8bba9a4",
			"key": "code",
			"value": "DUNNING_WF"
		},
		{
			"id": "d0eee7b1-72a6-4224-989b-333a4d65acce",
			"key": "description",
			"value": "dunning workflow"
		},
		{
			"id": "5a368450-8273-478b-adfc-0399198ae8a2",
			"key": "class",
			"value": "org.meveo.model.payments.CustomerAccount"
		},
		{
			"id": "7345da0b-9c09-4a0b-ac85-159775ffefe0",
			"key": "desc",
			"value": "dunning workflow"
		},
		{
			"id": "2629f809-b66a-4962-9aa1-8341d90d3a25",
			"key": "script_desc",
			"value": "Simple Dunning script"
		}
	],
	"protocolProfileBehavior": {}
}